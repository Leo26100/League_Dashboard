---
title: "Untitled"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=15, fig.height=8) 
suppressWarnings(library(rvest))
suppressWarnings(library(httr))
suppressWarnings(library(tidyverse))
suppressWarnings(library(dplyr))
suppressWarnings(library(shiny))
suppressWarnings(library(shinydashboard))

#Worlds match history----
MatchHistory_url <- "https://lol.gamepedia.com/index.php?pfRunQueryFormName=MatchHistoryGame&title=Special%3ARunQuery%2FMatchHistoryGame&MHG%5Bpreload%5D=Tournament&MHG%5Btournament%5D=2019+Season+World+Championship%2FMain+Event&MHG%5Bteam%5D=&MHG%5Bteam1%5D=&MHG%5Bteam2%5D=&MHG%5Bban%5D=&MHG%5Brecord%5D=&MHG%5Bascending%5D%5Bis_checkbox%5D=true&MHG%5Blimit%5D=77&MHG%5Bwhere%5D=&MHG%5Btextonly%5D%5Bis_checkbox%5D=true&MHG%5Btextonly%5D%5Bvalue%5D=1&wpRunQuery=Run+query&pf_free_text="

MatchHistory_html <- read_html(MatchHistory_url)

MatchHistory_nonTidy_df <- html_table(MatchHistory_html, fill = TRUE)

MatchHistory_nonTidy_df <- MatchHistory_nonTidy_df[1] %>%
  as.data.frame()
MatchHistory_ColumnNames <- MatchHistory_nonTidy_df[1,]
names(MatchHistory_nonTidy_df) <- MatchHistory_ColumnNames 

MatchHistory_nonTidy_df <- MatchHistory_nonTidy_df[3:length(MatchHistory_nonTidy_df$Date),] %>%
  rowid_to_column("ID")

#Worlds Pick and Ban------
xpath_pbh = "//*[@id='pbh-table']"
PickandBan_url <- "https://lol.gamepedia.com/Special:RunQuery/PickBanHistory?PBH%5Bpage%5D=Worlds%202019%20Main%20Event&PBH%5Btextonly%5D=Yes&pfRunQueryFormName=PickBanHistory"

PickandBan_html <- read_html(PickandBan_url)

PickandBan_df <- html_node(PickandBan_html, xpath = xpath_pbh)

PickandBan_df_non_tidy <- html_table(PickandBan_df, header = FALSE)

names <- PickandBan_df_non_tidy[2,]

names(PickandBan_df_non_tidy) <- names

PickandBan_df_non_tidy <- PickandBan_df_non_tidy[3:length(PickandBan_df_non_tidy$Phase),]%>%
  as_tibble() %>%
  separate(col = `RP1-2`, into = c("RP1", "RP2"), sep = ", ") %>%
  separate(col = `BP2-3`, into = c("BP2", "BP3"), sep = ", ") %>%
  separate(col = `BP4-5`, into = c("BP4", "BP5"), sep = ", ") 

PickandBan_df_non_tidy <- PickandBan_df_non_tidy %>% 
  rowid_to_column("ID") %>%
  subset(select = c(ID,Phase:Score, BB1:RR5)) 
#Only having an Winner DF
Winner_df <- MatchHistory_nonTidy_df['Winner'] %>%
  rowid_to_column("ID")

#Tidying Picks Table----

Picks_df_non_tidy <- PickandBan_df_non_tidy %>%
  subset(select = -c(BB1:RB3,RB4:BB5))

Picks_df <- Picks_df_non_tidy %>%
  pivot_longer(cols = c(BP1:RP5),
               names_to = "Side",
               values_to = "Champions") %>%
  pivot_longer(cols = c(BR1:RR5),
               names_to = "Selection",
               values_to = "Role")
Picks_df$Side <-  gsub("P","R",Picks_df$Side)

Picks_df <- Picks_df %>%
  filter(Side == Selection) %>%
  subset(select = c(Phase:Champions, Role, ID)) %>% 
  separate(col = Side, into = c("Side", "Order"), sep = 2) 
Picks_df$Side[Picks_df$Side == "RR"] <- "Red"
Picks_df$Side[Picks_df$Side == "BR"] <- "Blue"

Picks_df <- Picks_df %>%
  pivot_longer(cols = c(Blue:Red),
               names_to = "Color",
               values_to = "Team") %>%
  filter(Side == Color) %>%
  subset(select = c(Phase:Role, Team, ID))
#Edits to make Picks_df add winner in df 
Picks_df <- full_join(Picks_df, Winner_df, by = 'ID')

Picks_df$Winner <- Picks_df$Team == Picks_df$Winner

Picks_df$Stage <- ifelse(grepl('^Day',Picks_df$Phase), "Group", "Knockout")
Picks_df$Stage <- ifelse(grepl('^Tiebreakers',Picks_df$Phase),"Group",Picks_df$Stage) 
  
#Tidying bans table ----
Bans_df_non_tidy <- PickandBan_df_non_tidy %>%
  subset(select = c(ID,Phase:RB3,RB4:BB5))

Bans_df <- Bans_df_non_tidy %>%
  pivot_longer(cols = c(BB1:BB5),
               names_to = "Side",
               values_to = "Champions") %>%
  separate(col = Side, into = c("Side", "Order"), sep = 2)

Bans_df$Side[Bans_df$Side == "BB"] <- "Blue"

Bans_df$Side[Bans_df$Side == "RB"] <- "Red"  

Bans_df <- Bans_df %>%
  pivot_longer(cols = c(Blue:Red),
               names_to = "Color",
               values_to = "Team") %>%
  filter(Side == Color) %>%
  subset(select = c(ID, Phase:Champions, Team))
Bans_df <- full_join(Bans_df, Winner_df, by = 'ID')

Bans_df$Winner <- Bans_df$Team == Bans_df$Winner
Bans_df$Stage <- ifelse(grepl('^Day',Bans_df$Phase), "Group", "Knockout")
Bans_df$Stage <- ifelse(grepl('^Tiebreakers',Bans_df$Phase),"Group",Bans_df$Stage) 

Favorite_theme  <- theme(axis.title = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = c(1,1), legend.justification = c(1,1),
        legend.background = element_blank(),
        legend.direction="horizontal",
        legend.title = element_blank(),
        axis.text.x = element_text(face= 'bold', size = 10))

Team_Names_Axis <- scale_x_discrete(labels=c("FunPlus Phoenix" = "FPX", "G2 Esports" = "G2", "SK Telecom T1" = "SKT", "Invictus Gaming" = "IG","DAMWON Gaming" = "DWG", "Splyce" =  "SPY", "Fnatic" = "FNC", "Griffin" = "GRF", "Team Liquid" = "TL", "ahq eSports Club" = "AHQ","Royal Never Give Up" = "RNG", "Clutch Gaming" = "CG", "Hong Kong Attitude" = "HKA", "Cloud9" = "C9", "J Team" = "JT", "GAM Esports" = "GAM"))

Picks_df <- Picks_df %>%
  mutate(Phase=as.factor(Phase), Side=as.factor(Side),Order=as.factor(Order),
         Champions=as.factor(Champions), Role=as.factor(Role), Team=as.factor(Team))

Bans_df %>%
    mutate(Phase=as.factor(Phase), Side=as.factor(Side),Order=as.factor(Order),
         Champions=as.factor(Champions), Team=as.factor(Team))
#Counts of the champiions picked by team
Team_count_df <- Picks_df %>%
  group_by(Role, Team)%>% 
  count(Champions) %>%
  ungroup()%>%
  count(Team) 
#Count of champions picked by Role
Picks_count_df <- Picks_df%>%
  group_by(Champions,Role)%>%
  count(Champions) 
# I am categorizing common picks as a champion that was picked at least 3 times by one or more teams
Picks_common_df <- Picks_df%>%
  group_by(Champions,Role, Team)%>%
  count(Champions) %>%
  filter(n > 2) %>%
  ungroup()%>%
  group_by(Champions,Role) %>%
  summarise(total = sum(n))

Picks_common_bot_df <- Picks_common_df %>%
  filter(Role == 'Bot Laner')

Bans_count_df <- Bans_df  %>% 
    group_by(Champions)%>%
  count(Champions)

Picks_bot_count_df<- Picks_count_df %>%  
  filter(Role == 'Bot Laner') %>%
  filter(n > 2)


```

## GitHub Documents

This is an R Markdown format used for publishing markdown documents to GitHub. When you click the **Knit** button all R code chunks are run and a markdown file (.md) suitable for publishing to GitHub is generated.

## Including Code

You can include R code in the document as follows:


## Including Plots

You can also embed plots, for example:

```{r echo=FALSE}
Picks_df %>%
  group_by(Role, Team)%>%
  count(Champions) %>%
  ggplot()+
  geom_bar(mapping = aes(x = Team, fill = Role))   +
  geom_text(data = Team_count_df, aes(x = Team, y = n,label = n),
            position = position_dodge(width = 1),
            vjust = -1) +
  labs(title = "Unique Champions Picked by Team per Role",
       subtitle ="Number of top is the total champions picked by the team. The bar are separeted by color per role and legend is on the top right") +
  theme_minimal()+
  scale_y_continuous() +
  Favorite_theme + 
  Team_Names_Axis

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r echo=FALSE}

Picks_bot_count_df %>%
ggplot(aes(x = Champions, y = n, fill = Champions))+
  geom_bar(stat = 'identity') + 
  geom_text(aes(label = n),
            position = position_dodge(width = 1),
            vjust = -1)  
```
```{r echo=FALSE}
Picks_bot_count_df %>%
  filter(Champions %in% Picks_common_bot_df$Champions) %>%
  ggplot(aes(x = Champions, y = n, fill = Champions))+
  geom_bar(stat = 'identity') + 
  geom_text(aes(label = n),
            position = position_dodge(width = 1),
            vjust = -1) 
```
```{r, echo = FALSE}
Bans_count_df %>%
  filter(Champions %in% Picks_common_bot_df$Champions) %>%
ggplot(aes(x = Champions, y = n, fill = Champions))+
  geom_bar(stat = 'identity') + 
  geom_text(aes(label = n),
            position = position_dodge(width = 1),
            vjust = -1)
```
```{r}
Picks_df %>%
  group_by(Role, Stage) %>%
  filter(Champions %in% Picks_common_bot_df$Champions)%>%
  count(Champions) %>%
  filter(Role == 'Bot Laner')%>%
  ggplot(mapping = aes(x = Champions, y = n, fill = Stage))+
  geom_bar(position = 'dodge', stat = 'identity')
```
```{r}
Bans_df %>%
  group_by(Stage) %>%
  filter(Champions %in% Picks_common_bot_df$Champions)%>%
  count(Champions) %>%
  ggplot(mapping = aes(x = Champions, y = n, fill = Stage))+
  geom_bar(position = 'dodge', stat = 'identity')
```
```{r}
Picks_bot_phase_count<- Picks_df %>%
  group_by(Role, Phase) %>%
  filter(Champions %in% Picks_common_bot_df$Champions)%>%
  count(Champions) %>%
  filter(Role == 'Bot Laner')

Bans_bot_common_phase_count<- Bans_df %>%
  group_by(Phase)%>%
  filter(Champions %in% Picks_common_bot_df$Champions)%>%
  count(Champions)
Picks_bot_phase_count$Phase <- factor(Picks_bot_phase_count$Phase, levels = c('Day 1','Day 2','Day 3','Day 4','Day 5',
                                                                              'Day 6','Day 7','Day 8','Tiebreakers',
                                                                              'Quarterfinals','Semifinals','Finals'))
Bans_bot_common_phase_count$Phase <- factor(Bans_bot_common_phase_count$Phase, levels = c('Day 1','Day 2','Day 3','Day 4',
                                                                                    'Day 5','Day 6','Day 7','Day 8',
                                                                                    'Tiebreakers','Quarterfinals',
                                                                                    'Semifinals','Finals'))

Picks_bot_phase_count%>%
  left_join(Bans_bot_common_phase_count, by = c('Champions','Phase')) %>%
  ggplot(mapping = aes(x = Phase, color = Champions, group = Champions))+
  geom_point(aes(y = n.x)) + 
  geom_text(aes(label = Champions, y = n.x), 
            position = position_dodge(width = 1),
            vjust = -1)
```